import"./modulepreload-polyfill.c7c6310f.js";const V={ok:"https://www.svgrepo.com/show/13650/success.svg",fail:"https://www.svgrepo.com/show/13658/error.svg",unknown:"https://www.svgrepo.com/show/146075/question.svg"},$={ok:"Up to date",fail:"Outdated",unknown:"Unknown. Recalculate to update!"};let v="";const F=(t,n)=>t.x-t.width/2>=n.x-n.width/2&&t.x+t.width/2<=n.x+n.width/2,T=(t,n)=>t.y-t.height/2>=n.y-n.height/2&&t.y+t.height/2<=n.y+n.height/2,B=(t,n)=>{if(F(t,n))return!0;const a=t.width/2,s=t.x-t.width/2,e=t.x+t.width/2,c=n.x-n.width/2,o=n.x+n.width/2;return s<=c&&e>=c&&e<=o?e-c>=a:s>=c&&s<=o&&e>=o?o-s>=a:!1},C=(t,n)=>{if(T(t,n))return!0;const a=t.height/2,s=t.y-t.height/2,e=t.y+t.height/2,c=n.y-n.height/2,o=n.y+n.height/2;return s<=c&&e>=c&&e<=o?e-c>=a:e>=o&&s<=o&&s>=c?o-s>=a:!1},I=t=>t.reduce((n,a)=>{var e,c;const s=Number((c=(e=a.content.match(/(?<points>\d+)pt/))==null?void 0:e.groups.points)!=null?c:0);return n+s},0),x=async t=>{const n=document.getElementById("board-status-icon"),a=document.getElementById("board-status-message");n.src=V[t],a.textContent=$[t]},z=async(t={})=>{if(!window.frame)return;const n=document.getElementById("board-stats");n.classList.contains("hidden")&&n.classList.remove("hidden");const a=document.getElementById("iteration-table");a.innerHTML="",Object.entries(t).sort(([s],[e])=>s.localeCompare(e)).forEach(([s,e])=>{const c=document.createElement("tr"),o=document.createElement("td");o.textContent=s;const r=document.createElement("td");r.textContent=e.velocity.toString();const i=document.createElement("td");i.textContent=e.load.toString();const l=document.createElement("td");l.textContent=e.diff.toString(),e.load>e.velocity&&(c.style.color="#f00"),c.appendChild(o),c.appendChild(r),c.appendChild(i),c.appendChild(l),a.appendChild(c)})},O=async()=>{const t=document.getElementById("frame-select"),a=(await miro.board.get()).filter(s=>s.type==="frame");a.forEach(s=>{t.options[t.options.length]=new Option(s.title,s.id)}),t.addEventListener("change",async s=>{const e=s.target.value;v=e,window.frame=a.filter(i=>i.id===e)[0];const c=document.getElementById("recalculate-button"),o=document.getElementById("export-button");c.disabled&&(c.disabled=!1),o.disabled&&(o.disabled=!1),await x("unknown");const r=await miro.board.events.broadcast("FRAMEID",e);console.log("broadcasted**************",e,r)})},S=async(t=v)=>{const n=await miro.board.get(),a=n.filter(o=>o.type==="sticky_note").filter(o=>o.parentId===t),s=n.filter(o=>o.type==="shape"),e=s.filter(o=>o.parentId===t).filter(o=>/Vel: \d+/i.test(o.content)),c=s.filter(o=>o.parentId===t).filter(o=>/size: \d+/i.test(o.content));return{stickers:a,iterations:e,features:c}},j=async(t=v)=>{if(!window.frame)return;const{stickers:n,iterations:a,features:s}=await S(t);await Promise.all(a.map(async e=>{var i,l;const c=n.filter(d=>d!==e&&B(d,e)),o=I(c),r=Number((l=(i=e.content.match(/vel: (?<vel>\d+)/i))==null?void 0:i.groups.vel)!=null?l:0);e.content=e.content.replace(/(ld: \d+)/i,`LD: ${o}`),o>r?e.style.fillColor="#ff0000":(e.style.fillColor="#414bb2",e.style.color="#ffffff"),await e.sync()})),await Promise.all(s.map(async e=>{const c=n.filter(r=>r!==e&&C(r,e)),o=I(c);e.content=e.content.replace(/(size: \d+)/i,`Size: ${o}`),await e.sync()})),await x("ok")},q=async(t=v)=>{if(!window.frame)return;const{stickers:n,iterations:a,features:s}=await S(t),e={},c=a.reduce((r,i)=>{var p,g,y,b,E;const l=n.filter(u=>u!==i&&B(u,i)),d=I(l),f=(p=i.content.match(/(?<name>I\d\.\d)/i))==null?void 0:p.groups.name,m=Number((y=(g=i.content.match(/vel: (?<count>\d+)/i))==null?void 0:g.groups.count)!=null?y:0),h=Number((E=(b=i.content.match(/ld: (?<count>\d+)/i))==null?void 0:b.groups.count)!=null?E:0),k=Math.abs(m-d);return f&&(e[f]={velocity:m,load:d,diff:k}),r&&d===h},!0),o=s.every(r=>{var f,m;const i=n.filter(h=>h!==r&&C(h,r)),l=I(i),d=Number((m=(f=r.content.match(/size: (?<count>\d+)/i))==null?void 0:f.groups.count)!=null?m:0);return l===d});c&&o?await x("ok"):await x("fail"),await z(e)},H=async(t=v)=>{var d,f,m,h,k,p,g,y,b,E;if(!window.frame)return;const n=["Display Color","Name","Unified Parent","Plan Estimate"],{stickers:a,iterations:s,features:e}=await S(t),c=[];for(const u of e){const D=a.filter(w=>w!==u&&C(w,u));for(const w of D)for(const L of s){if(!B(w,L))continue;const N=(f=(d=L.content.match(/(?<name>I\d\.\d)/i))==null?void 0:d.groups.name)!=null?f:"",A=(m=w.content)!=null?m:"Unknown text",M=(k=(h=u.style)==null?void 0:h.backgroundColor)!=null?k:"#808080",P=`${N} ${A.replace(/(\d+pt)/,"")}`.trim(),R=(g=(p=u.content.match(/(?<feat>F\d+)/i))==null?void 0:p.groups.feat)!=null?g:"",W=(b=(y=w.content.match(/(?<points>\d+)pt/))==null?void 0:y.groups.points)!=null?b:"";if(!W||!R)continue;const U=[M,P,R,W];c.push(U)}}const o=`data:text/csv;base64,${btoa([n,...c].map(u=>u.join(",")).join(`
`))}`,r=encodeURI(o),i=document.createElement("a");i.setAttribute("href",r),i.setAttribute("download",`${(E=window.frame.title)!=null?E:"Board data"}.csv`),i.click(),document.getElementById("export-warning").classList.remove("hidden")},_=async()=>{await O();let t;if(miro.board.events.on("FRAMEID",async s=>{t=s,await miro.board.notifications.showInfo(s)}),document.getElementById("recalculate-button").addEventListener("click",()=>j(t)),document.getElementById("export-button").addEventListener("click",H),setInterval(()=>q(t),1e3),t){window.frame=(await miro.board.get({id:t}))[0];const s=document.getElementById("frame-select"),e=Array.from(s.options).find(c=>c.value===t);e&&(e.selected=!0,s.dispatchEvent(new Event("change")))}};_();
